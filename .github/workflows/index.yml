name: Generate and Deploy Index

on:
  push:
    branches:
      - main
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
      - name: Add Front Matter to All Markdown Files
        run: |
          for file in master/*.md engines/*.md helpers/*.md roles/*/*.md templates/*.md; do
            [ -e "$file" ] || continue
            if ! grep -q '^---' "$file"; then
              sed -i '1i ---' "$file"
              echo "---" >> "$file"
            fi
          done

      - name: Generate Index with Pretty URLs
        run: |
          echo "---" > index.md
          echo "layout: default" >> index.md
          echo "title: InfoSec Prompt Library Index" >> index.md
          echo "---" >> index.md
          echo "" >> index.md
          echo "# ðŸ“š InfoSec Prompt Library Index" >> index.md
          echo "" >> index.md

          # Governance
            echo "## Governance" >> index.md
            for file in $(ls master/*.md 2>/dev/null | sort); do
            name=$(basename "$file" .md)
            echo "- $name" >> index.md
            done

            # Engines
            echo "" >> index.md
            echo "## Engines" >> index.md
            for file in $(ls engines/*.md 2>/dev/null | sort); do
            name=$(basename "$file" .md)
            echo "- $name" >> index.md
            done

            # Helpers
            echo "" >> index.md
            echo "## Helpers" >> index.md
            for file in $(ls helpers/*.md 2>/dev/null | sort); do
            name=$(basename "$file" .md)
            echo "- $name" >> index.md
            done

            # Roles
            echo "" >> index.md
            echo "## Roles" >> index.md
            for dir in $(ls -d roles/* 2>/dev/null | sort); do
            role=$(basename "$dir")
            echo "### $role" >> index.md
            for file in $(ls "$dir"/*.md 2>/dev/null | sort); do
                name=$(basename "$file" .md)
                echo "- $name" >> index.md
            done
            done

            # Templates
            echo "" >> index.md
            echo "## Templates" >> index.md
            for file in $(ls templates/*.md 2>/dev/null | sort); do
            name=$(basename "$file" .md)
            echo "- $name" >> index.md
            done

      - name: Commit Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add index.md master/*.md engines/*.md helpers/*.md roles/*/*.md templates/*.md
          git diff --cached --quiet || git commit -m "Update index with pretty URLs"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:main

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    needs: build-index
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
